# FastSpeech2 模型训练与推理操作指南

本项目实现了从零开始的 FastSpeech2 语音合成模型，用于学习和研究目的。

## 环境配置

### 1. 环境说明
- **aligner 环境**：用于数据预处理和音素对齐
- **scratch-models 环境**：用于模型训练和推理

### 2. MFA (Montreal Forced Alignment) 安装

**重要提示**：必须使用 Conda 安装 MFA，避免 pip 安装导致的依赖问题。

```bash
# 激活目标环境
conda activate scratch-models

# 卸载可能存在的 pip 版本
pip uninstall montreal-forced-aligner

# 使用 conda-forge 频道安装（官方推荐）
conda install -c conda-forge montreal-forced-aligner
```

**常见问题解决**：
- 错误：`No module named '_kalpy'`
- 原因：pip 安装缺少底层 Kalpy 引擎
- 解决：使用 conda 安装即可解决

## 完整操作流程

### 步骤 1：数据预处理与音素对齐

```bash
# 激活数据预处理环境
conda activate aligner

# 下载 MFA 声学模型和词典
mfa model download acoustic english_us_arpa
mfa model download dictionary english_us_arpa

# 执行文本音素对齐
mfa align ./corpus english_us_arpa english_us_arpa ./corpus_aligned
```

**说明**：此步骤为每条音频文本生成对应的音素序列，为后续训练提供对齐数据。

### 步骤 2：构建数据集

```bash
# 激活训练环境
conda activate scratch-models

# 构建 tokenizer 词表，生成训练集和验证集
python fastspeech2_dataset.py > dataset.log 2>&1
```

### 步骤 3：模型训练

```bash
# 确保在训练环境中
conda activate scratch-models

# 开始训练
python fastspeech2_train.py > train.log 2>&1
```

**注意**：训练过程会生成详细的日志文件，可通过 `tail -f train.log` 实时查看训练进度。

### 步骤 4：模型推理

#### 4.1 文本转音素

```bash
# 激活数据预处理环境
conda activate aligner

# 将输入文本转换为音素
mfa g2p input_texts.txt english_us_arpa output_phonemes.txt --num_pronunciations 1
```

**重要**：
- `input_texts.txt` 中存放需要合成的文本
- 所有文本必须转换为小写
- 每行一个句子

#### 4.2 执行推理

```bash
# 激活训练环境
conda activate scratch-models

# 运行推理脚本
python fastspeech2_inference.py
```

**输出**：生成的音频文件保存在 `./outputs/output_from_phonemes.wav`

## 文件结构说明

```
fastspeech2/
├── corpus/                    # 原始音频数据
├── corpus_aligned/           # 音素对齐后的数据
├── processed_data/           # 处理后的训练数据
├── checkpoints/              # 模型检查点
├── outputs/                  # 推理输出
├── input_texts.txt          # 推理输入文本
├── output_phonemes.txt      # 转换后的音素
└── *.log                    # 各种日志文件
```

## 注意事项

1. **环境切换**：不同步骤需要在不同 conda 环境中执行
2. **数据格式**：输入文本必须为小写
3. **路径检查**：确保所有文件路径正确
4. **资源监控**：训练过程需要较多计算资源，建议监控 GPU 使用情况

## 故障排除

- 如遇到 MFA 相关错误，请确保使用 conda 安装而非 pip
- 训练中断后可从检查点恢复
- 推理失败时检查输入文本格式和音素转换结果 
